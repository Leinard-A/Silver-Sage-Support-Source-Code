<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Silver Sage Support</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      h1 {
        text-align: center;
        margin: 10px;
      }

      th {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
        background-color: #f2f2f2;
      }

      td {
        padding: 10px;
      }
    </style>
  </head>

  <body onload = 'loadFunction()'>
    <header>
      <h1>Silver Sage Support</h1>
    </header>

    <nav>
      <a href="index.html">Home</a>
      <a href="about.html">About</a>
      <a href="contact.html">Contact</a>
      <a href="login.html">Logout</a>
    </nav>

    <h1>Account Information | Send a messagage to an employee</h1>

    <div class = "team">
      <div class="accountBox">
        <table class="table2">
          <tr>
            <th class="">Full Name</th>
            <td id="fullname"></td>
          </tr>
          <tr>
            <th>Email</th>
            <td id="email"></td>
          </tr>
          <tr>
            <th>Username</th>
            <td id="username"></td>
          </tr>
          <tr>
            <th>Date of Birth</th>
            <td id="dateOfBirth"></td>
          </tr>
          <tr>
            <th>Gender</th>
            <td id="gender"></td>
          </tr>
          <tr>
            <th>nhsNumber</th>
            <td id="nhsNumber"></td>
          </tr>
          <tr>
            <th>insuranceProvider</th>
            <td id="insuranceProvider"></td>
          </tr>
          <tr>
            <th>insuranceNumber</th>
            <td id="insuranceNumber"></td>
          </tr>
        </table>
      </div>
      <div class="accountBox">
        <form class="message" action="javascript:sendMessage()">
          <label for="chooseEmployee">Choose which employee you would like to contact:</label>
          <select id="chooseEmployee" name="chooseEmployee">
          </select>
          <label for="message">Message:</label>
          <textarea id="message" name="message" oninput="autoResize(this)" class="textbox" placeholder="Enter your message here please  "></textarea>  
          <input type="submit" value="Send">
          <h2>Recived messages</h2>
          <table id="tableMessages">
            <tr>
              <th>Date of Message:</th>
              <th>Message:</th>
              <th>Sender:</th>
            </tr>
          </table>
        </form>
      </div>
    </div>

    <footer>
      <p>&copy; 2024 Silver Sage Support</p>
    </footer>

    <script>
      function loadFunction() {
        getUserInfo();
        getStaffEmail();
        getMessages();
      }
      function getMessages(){
        const recievedMessages = document.getElementById('tableMessages');
        const sessionID = getSessionID();
        fetch('https://mi-linux.wlv.ac.uk/~2201213/Collab/getMessages.php?sessionID='+sessionID)
       .then(response => response.json())
       .then(response => {
         console.log(response);
         if (response.NoMessages){
            console.log("No messages received");
         } 
         else{
          console.log(response.length);  
          for (let i = 0; i < response.length; i++){
            recievedMessages.innerHTML += "<tr> \
                                              <td>"+response[i][2]+"</td> \
                                              <td>"+response[i][1]+"</td> \
                                              <td>"+response[i][0]+"</td> \
                                            </tr>";
           }
         }

       })
      }
      function getStaffEmail(){
          //Dynamically display the staff emails that users can send messages to.
          const staffSelection = document.getElementById("chooseEmployee");
          fetch('https://mi-linux.wlv.ac.uk/~2201213/Collab/getStaffEmails.php')
          .then(response => response.json())
          .then(response => {
             for (let i = 0; i < response.length; i++) {
                 staffSelection.innerHTML += "<option value='" + response[i] + "'>" + response[i] + "</option>";
             }
          })
 
      }
      function getSessionID(){
          const urlParams = new URLSearchParams(window.location.search);
          const sessionID = urlParams.get("sessionID");
          return sessionID 
      }   
      function getUserInfo() {
          const sessionID = getSessionID();
          const fullname = document.getElementById("fullname");
          const email = document.getElementById("email");
          const username = document.getElementById("username");
          const dateOfBirth = document.getElementById("dateOfBirth");
          const gender = document.getElementById("gender");
          const nhsNumber = document.getElementById("nhsNumber");
          const insuranceProvider = document.getElementById("insuranceProvider");
          const insuranceNumber = document.getElementById("insuranceNumber");
          const employeeMenu = document.getElementById("employeeMenu");
          fetch(
            "https://mi-linux.wlv.ac.uk/~2201213/Collab/getUserInfo.php?sessionID="+sessionID)
            .then((response) => response.json())
            .then((response) => {
              if (response.sessionID == "False") {
                window.location.replace("login.html");
              } else {
                if (response.employee == 1){

                }
                fullname.innerHTML = response.fullname;
                email.innerHTML = response.email;
                username.innerHTML = response.username;
                dateOfBirth.innerHTML = response.dateofBirth;
                gender.innerHTML = response.gender;
                nhsNumber.innerHTML = response.nhsNumber;
                if (
                  response.insuranceNumber == null &&
                  response.insuranceProvider == null
                ) {
                  insuranceProvider.innerHTML = "No Insurance";
                  insuranceNumber.innerHTML = "No Insurance";
                } else {
                  insuranceProvider.innerHTML = response.insuranceProvider;
                  insuranceNumber.innerHTML = response.insuranceNumber;
                }
              }
            });
        }
      function sendMessage() {
          const sessionID = getSessionID();
          const message = document.getElementById("message").value;
          const employeeSelection = document.getElementById("chooseEmployee");
          const employeeEmail = employeeSelection.value;
          fetch(
            "https://mi-linux.wlv.ac.uk/~2201213/Collab/sendMessage.php?"+
              "sessionID="+sessionID+ 
              "&userMessage="+message+
              "&recipientEmail="+employeeEmail)
          .then(response => response.json())
          .then(response => {
            if (response.MessageSent) {
              alert("Message sent successfully");
              window.location.replace("index.html");
            } else {
              alert("Message not sent");
            }
            window.location.replace("userPage.html?sessionID="+sessionID)
          })
      }
      function autoResize(textbox) {
        textbox.style.height = 'auto';
        textbox.style.height = (textbox.scrollHeight) + 'px';
      }
    </script>
  </body>
</html>
